
{% block content %}
<h1>{% if form.instance.pk %}Редактирование чека №{{ form.instance.number }}{% else %}Создание нового чека{% endif %}</h1>

<form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    
    <h3>Товары в чеке:</h3>
    {{ formset.management_form }}
    <table class="table">
        {% for form in formset %}
        <tr>
            <td>{{ form.product }}</td>
            <td>{{ form.quantity }}</td>
            <td>{% if form.instance.pk %}{{ form.DELETE }}{% endif %}</td>
        </tr>
        {% endfor %}
    </table>
    
    <button type="submit" class="btn btn-primary">Сохранить</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('products-form-container');
    const addButton = document.getElementById('add-product');
    const totalForms = document.getElementById('id_products-TOTAL_FORMS');
    let formCount = parseInt(totalForms.value);
    
    addButton.addEventListener('click', function() {
        const newForm = document.createElement('div');
        newForm.classList.add('product-form');
        newForm.innerHTML = `
            <p>
                <label for="id_products-${formCount}-product">Товар:</label>
                <select name="products-${formCount}-product" id="id_products-${formCount}-product">
                    {% for product in products %}
                        <option value="{{ product.id }}">{{ product.name }} ({{ product.price }})</option>
                    {% endfor %}
                </select>
            </p>
            <p>
                <label for="id_products-${formCount}-quantity">Количество:</label>
                <input type="number" name="products-${formCount}-quantity" value="1" min="1" id="id_products-${formCount}-quantity">
            </p>
            <p>
                <input type="hidden" name="products-${formCount}-id" id="id_products-${formCount}-id">
                <input type="checkbox" name="products-${formCount}-DELETE" id="id_products-${formCount}-DELETE">
                <label for="id_products-${formCount}-DELETE">Удалить</label>
            </p>
        `;
        container.appendChild(newForm);
        formCount++;
        totalForms.value = formCount;
    });
});
</script>
{% endblock %}